services:
  control-plane:
    image: ghcr.io/agent-field/agentfield-control-plane:latest
    ports:
      - "8080:8080"
    environment:
      - AGENTFIELD_HTTP_ADDR=0.0.0.0:8080
      - AGENTFIELD_STORAGE_MODE=local
    volumes:
      - agentfield-data:/data

  swe-agent:
    build:
      context: .
      dockerfile: Dockerfile
    env_file: .env
    environment:
      - AGENTFIELD_SERVER=http://control-plane:8080
      - NODE_ID=swe-planner
      - PORT=8003
      - AGENT_CALLBACK_URL=http://swe-agent:8003
    ports:
      - "8003:8003"
    volumes:
      - workspaces:/workspaces
    depends_on:
      - control-plane
    deploy:
      replicas: 1  # Scale with: docker compose up --scale swe-agent=3

  swe-fast:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["python", "-m", "swe_af.fast"]
    environment:
      - AGENTFIELD_SERVER=http://control-plane:8080
      - NODE_ID=swe-fast
      - PORT=8004
      - AGENT_CALLBACK_URL=http://swe-fast:8004
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN}
      - GH_TOKEN=${GH_TOKEN}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - OPENCODE_MODEL=${OPENCODE_MODEL:-}
    ports:
      - "8004:8004"
    volumes:
      - workspaces:/workspaces
    depends_on:
      - control-plane

volumes:
  agentfield-data:
  workspaces:
